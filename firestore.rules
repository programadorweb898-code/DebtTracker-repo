/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for debtors and their debt records.
 * All data is nested under /debtors/{debtorId}/debtRecords/{debtRecordId}, ensuring a clear ownership hierarchy.
 *
 * Core Philosophy:
 *  - Enforce strong ownership: Only the owner (identified by debtorId) can create, read, update, or delete debtors and debt records.
 *  - Authorization Independence: Denormalize debtorId into each DebtRecord document to allow validation without get() calls.
 *  - Segregation of data: Debtors and debt records are stored in separate collections to allow secure list operations.
 *
 * Key Security Decisions:
 *  - Strict ownership: No shared access or roles are implemented.
 *  - Ownership enforcement: Only the user with a matching debtorId can perform operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the `/debtors` collection, enforcing ownership.
     * @path /debtors/{debtorId}
     * @allow (create) - User abc can create a new debtor profile with id 'abc'.
     *   request.auth.uid == 'abc' and request.resource.data.id == 'abc'
     * @allow (get, list) - User abc can read debtor profile with id 'abc'.
     *   request.auth.uid == 'abc' and resource.data.id == 'abc'
     * @allow (update, delete) - User abc can modify/delete debtor profile with id 'abc'.
     *   request.auth.uid == 'abc' and resource.data.id == 'abc'
     * @deny (create) - User def cannot create a new debtor profile with id 'abc'.
     *   request.auth.uid == 'def' and request.resource.data.id == 'abc'
     * @deny (update, delete) - User def cannot modify/delete debtor profile with id 'abc'.
     *   request.auth.uid == 'def' and resource.data.id == 'abc'
     * @principle Enforces document ownership for writes, restricts access to a user's own data.
     */
    match /debtors/{debtorId} {
      // Helpers
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(debtorId) {
        return isSignedIn() && request.auth.uid == debtorId;
      }

      function isExistingOwner(debtorId) {
        return isOwner(debtorId) && resource != null;
      }

      // Read rules
      allow get: if true;
      allow list: if isSignedIn();

      // Write rules
      allow create: if isOwner(debtorId) && request.resource.data.id == debtorId;
      allow update: if isExistingOwner(debtorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(debtorId);
    }

    /**
     * @description Protects the `/debtors/{debtorId}/debtRecords` subcollection, enforcing ownership via debtorId.
     * @path /debtors/{debtorId}/debtRecords/{debtRecordId}
     * @allow (create) - User abc can create a new debt record for debtor abc.
     *   request.auth.uid == 'abc' and request.params.debtorId == 'abc'
     * @allow (get, list) - User abc can read debt records for debtor abc.
     *   request.auth.uid == 'abc' and request.params.debtorId == 'abc'
     * @allow (update, delete) - User abc can modify/delete debt record for debtor abc.
     *   request.auth.uid == 'abc' and request.params.debtorId == 'abc'
     * @deny (create) - User def cannot create a new debt record for debtor abc.
     *   request.auth.uid == 'def' and request.params.debtorId == 'abc'
     * @deny (update, delete) - User def cannot modify/delete debt record for debtor abc.
     *   request.auth.uid == 'def' and request.params.debtorId == 'abc'
     * @principle Enforces document ownership for writes, restricts access to a user's own data.
     */
    match /debtors/{debtorId}/debtRecords/{debtRecordId} {
      // Helpers
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(debtorId) {
        return isSignedIn() && request.auth.uid == debtorId;
      }

      function isExistingOwner(debtorId) {
        return isOwner(debtorId) && resource != null;
      }

      // Read rules
      allow get: if isOwner(debtorId);
      allow list: if isOwner(debtorId);

      // Write rules
      allow create: if isOwner(debtorId) && request.resource.data.debtorId == debtorId;
      allow update: if isExistingOwner(debtorId) && request.resource.data.debtorId == resource.data.debtorId;
      allow delete: if isExistingOwner(debtorId);
    }
  }
}